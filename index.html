<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Research Stats Tool v5.6 (Methodology Edition)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #7c3aed; --primary-dark: #5b21b6; --primary-light: #ddd6fe;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --gray: #6b7280; --bg-body: #f3f4f6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            background-attachment: fixed; color: #1f2937; line-height: 1.6; padding-bottom: 50px;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        .main-title {
            font-family: 'Prompt', sans-serif; font-size: 2.2rem; font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px;
        }
        .subtitle { color: var(--gray); font-family: 'Prompt'; font-size: 1rem; }

        .card {
            background: white; border-radius: 16px; padding: 30px; margin-bottom: 25px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255,255,255,0.8);
        }

        .test-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .test-btn {
            padding: 10px 24px; border: 2px solid var(--primary-light); background: white;
            border-radius: 50px; font-family: 'Prompt'; font-weight: 500; cursor: pointer; transition: 0.2s; color: var(--gray);
        }
        .test-btn:hover { border-color: var(--primary); color: var(--primary); }
        .test-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .section-title {
            font-family: 'Prompt'; font-size: 1.2rem; color: var(--primary); margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px;
        }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; font-family: 'Sarabun'; transition: 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); }

        .co-input-wrapper { display: flex; gap: 10px; }
        .add-btn {
            background: var(--primary); color: white; border: none; border-radius: 12px;
            width: 50px; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
        }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag {
            background: #eef2ff; color: var(--primary); border: 1px solid #c7d2fe;
            padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
        }

        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px; font-family: 'Prompt'; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: white;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); }
        .btn-save { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .btn-save.editing { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }
        .btn-print { background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); }
        .btn-outline { background: white; border: 2px solid #e5e7eb; color: var(--gray); }
        .btn-edu { background: #334155; color: white; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .setting-card { background: #fff; border: 2px solid #e5e7eb; padding: 15px; border-radius: 12px; position: relative; }

        .stats-summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;
        }
        .stat-item {
            background: #f8fafc; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e2e8f0;
        }
        .stat-lbl {
            font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;
        }
        .stat-val {
            font-size: 1.5rem; font-weight: 700; font-family: 'Prompt'; color: var(--primary);
        }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); overflow-y: auto;
        }
        .modal-content {
            background-color: #fff; margin: 5% auto; padding: 30px; border-radius: 20px;
            width: 80%; max-width: 900px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-body { color: #334155; font-size: 1rem; line-height: 1.7; }
        .close-modal { font-size: 28px; font-weight: bold; color: #94a3b8; cursor: pointer; }
        .close-modal:hover { color: var(--danger); }
        .formula-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin: 15px 0; overflow-x: auto; text-align: center; }

        .result-section { display: none; }
        .result-header { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .p-value-card, .ci-card {
            background: white; padding: 20px; border-radius: 16px; text-align: center;
            border: 2px solid #e5e7eb; display: flex; flex-direction: column; justify-content: center;
        }
        .p-value-card.sig { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .p-value-card.ns { background: #f3f4f6; border-color: #9ca3af; color: #374151; }
        .display-val { font-size: 2.2rem; font-weight: 800; font-family: 'Prompt'; line-height: 1; margin: 5px 0; }

        .analysis-box {
            background: #fff; border: 1px solid #e2e8f0; border-left: 5px solid var(--primary);
            padding: 25px; border-radius: 12px; margin-top: 25px;
        }
        .h-badge { display: inline-block; padding: 6px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; margin-bottom: 15px; }
        .h-reject { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .h-accept { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .method-option { margin-bottom: 12px; }
        .method-label { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border-radius: 8px; }
        .method-label:hover { background: #f8fafc; }
        .method-label input[type="radio"] { width: 18px; height: 18px; }
        .info-icon { color: #6b7280; cursor: help; font-size: 14px; margin-left: auto; }
        .auto-recommendation {
            background: #f0f9ff; padding: 8px 12px; border-radius: 8px; border-left: 3px solid #0ea5e9;
            margin-left: 30px; font-size: 0.85rem; margin-top: 5px;
        }
        .critical-value-display {
            background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #e2e8f0;
        }

        .history-section { margin-top: 30px; }
        .history-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .history-search {
            flex: 1; padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-family: 'Sarabun'; font-size: 0.9rem;
        }
        .clear-history-btn {
            background: #ef4444; color: white; border: none; padding: 10px 20px;
            border-radius: 12px; cursor: pointer; font-family: 'Prompt'; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }
        .history-table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e5e7eb; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .history-table th {
            background: #f8fafc; padding: 12px 15px; text-align: left; font-weight: 600;
            color: #374151; border-bottom: 2px solid #e5e7eb; font-family: 'Prompt';
        }
        .history-table td {
            padding: 10px 15px; border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }
        .history-table tr:hover { background: #f9fafb; }
        .action-buttons { display: flex; gap: 8px; }
        .action-btn {
            padding: 4px 8px; border-radius: 6px; border: none; cursor: pointer;
            font-size: 0.8rem; display: flex; align-items: center; gap: 4px;
        }
        .view-btn { background: #dbeafe; color: #1e40af; }
        .edit-btn { background: #fef3c7; color: #92400e; }
        .delete-btn { background: #fee2e2; color: #991b1b; }
        .print-btn { background: #dcfce7; color: #166534; }

        .empty-history { text-align: center; padding: 40px; color: #9ca3af; font-style: italic; }
        .history-count { font-size: 0.85rem; color: #6b7280; margin-top: 10px; }

        .app-footer { text-align: center; margin-top: 40px; padding: 20px; color: #6b7280; font-size: 0.9rem; border-top: 1px solid #e5e7eb; }
        .screen-only { display: block; }
        .print-only { display: none !important; }

        .print-header { display: none; }

        @media (max-width: 768px) {
            .modal-content { width: 95%; margin: 10% auto; padding: 15px; }
            .result-header, .settings-grid { grid-template-columns: 1fr; }
            .stats-summary { grid-template-columns: repeat(2, 1fr); }
            .history-table th, .history-table td { padding: 8px 10px; }
            .action-buttons { flex-direction: column; }
        }

        @media print {
            @page {
                size: A4;
                margin: 1.5cm 1.5cm;
            }
            
            /* ปรับปรุงหลักเพื่อป้องกันหน้าแรกล้น */
            body {
                background: white !important;
                font-family: 'Sarabun', sans-serif !important;
                font-size: 11pt !important; /* ลดขนาดฟอนต์จาก 12pt */
                line-height: 1.4 !important; /* ลดระยะห่างบรรทัด */
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* ซ่อนองค์ประกอบที่ไม่จำเป็นสำหรับการพิมพ์ */
            .screen-only,
            header,
            .btn-group,
            .app-footer,
            .modal,
            .test-buttons,
            .btn,
            .info-icon,
            .auto-recommendation,
            .critical-value-display,
            #warningMessage,
            .add-btn,
            .tag-container,
            .history-section,
            .history-controls,
            .history-table-container,
            #resultSection .btn-group,
            #resultSection .screen-only,
            .ph,
            .main-title,
            .subtitle,
            .test-btn,
            .co-input-wrapper,
            .group-box,
            .settings-grid,
            .setting-card,
            .method-label input[type="radio"],
            #autoRecommendation,
            #criticalValueDisplay,
            #ciLevelInfo,
            .stats-summary,
            .analysis-box .h-badge,
            .result-section .section-title,
            .container > header,
            .container > .card:first-child,
            .container > .card:nth-child(2),
            .container > .history-section,
            .container > .app-footer,
            #eduModal,
            #methodInfoModal {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                width: 0 !important;
                position: absolute !important;
                overflow: hidden !important;
            }
            
            .print-only {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                width: 100% !important;
                position: relative !important;
            }
            
            #printContent {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* ปรับปรุง header หน้าแรกให้กะทัดรัด */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 15px !important; /* ลด margin จาก 30px */
                padding-bottom: 10px !important; /* ลด padding จาก 20px */
                border-bottom: 2px solid #000 !important; /* ลดจาก 3px */
            }
            
            .print-header h1 {
                font-family: 'Prompt', sans-serif !important;
                font-size: 20pt !important; /* ลดจาก 24pt */
                color: #000 !important;
                margin-bottom: 5px !important; /* ลดจาก 8px */
                font-weight: bold !important;
            }
            
            .print-header .subtitle {
                display: block !important;
                font-size: 12pt !important; /* ลดจาก 14pt */
                color: #666 !important;
                font-family: 'Prompt', sans-serif !important;
                font-weight: 500 !important;
            }
            
            /* ปรับปรุง meta info ให้กะทัดรัด */
            .print-meta {
                display: flex !important;
                justify-content: space-between;
                font-size: 10pt !important; /* ลดจาก 11pt */
                color: #666 !important;
                margin-bottom: 15px !important; /* ลดจาก 25px */
                padding-bottom: 10px !important; /* ลดจาก 15px */
                border-bottom: 1px solid #ddd !important;
            }
            
            /* ปรับปรุง title ให้กะทัดรัด */
            .print-report-title {
                display: block !important;
                text-align: center;
                font-family: 'Prompt', sans-serif !important;
                font-size: 16pt !important; /* ลดจาก 18pt */
                margin: 15px 0 !important; /* ลดจาก 25px */
                padding: 12px !important; /* ลดจาก 15px */
                background: #f5f5f5 !important;
                border: 1px solid #000 !important; /* ลดจาก 2px */
                font-weight: bold !important;
            }
            
            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
            }
            
            /* ปรับปรุง card ให้กะทัดรัด */
            .card {
                display: block !important;
                box-shadow: none !important;
                border: 1px solid #000 !important; /* ลดจาก 2px */
                border-radius: 0 !important;
                padding: 20px !important; /* ลดจาก 25px */
                margin: 0 0 20px 0 !important; /* ลดจาก 25px */
                background: white !important;
                page-break-inside: avoid !important;
            }

            .section-title {
                display: block !important;
                font-family: 'Prompt', sans-serif !important;
                font-size: 12pt !important; /* ลดจาก 14pt */
                color: #000 !important;
                border-bottom: 1px solid #000 !important; /* ลดจาก 2px */
                padding-bottom: 6px !important; /* ลดจาก 8px */
                margin-bottom: 15px !important; /* ลดจาก 20px */
                font-weight: 600 !important;
            }

            /* ปรับปรุง project info ให้กะทัดรัด */
            .project-info-print {
                display: block !important;
                margin-bottom: 15px !important; /* ลดจาก 25px */
                padding-bottom: 10px !important; /* ลดจาก 15px */
                border-bottom: 1px solid #ddd !important;
            }
            .project-info-print p {
                display: block !important;
                margin: 4px 0 !important; /* ลดจาก 5px */
                font-size: 11pt !important; /* ลดจาก 12pt */
                line-height: 1.5 !important; /* ลดจาก 1.6 */
            }

            /* ปรับปรุง conclusion section ให้กะทัดรัด */
            .conclusion-section {
                display: block !important;
                margin-top: 5px !important; /* ลดจาก 10px */
                padding: 15px !important; /* ลดจาก 20px */
                border: 1px solid #000 !important; /* ลดจาก 2px */
                background: #f9f9f9 !important;
            }
            
            .conclusion-section h3 {
                font-size: 13pt !important;
                margin-bottom: 10px !important;
            }
            
            .conclusion-text {
                display: block !important;
                font-size: 11pt !important; /* ลดจาก 12pt */
                line-height: 1.5 !important; /* ลดจาก 1.6 */
                margin-bottom: 15px !important; /* ลดจาก 20px */
            }
            
            /* ปรับปรุง signature ให้กะทัดรัด */
            .signature-section {
                display: block !important;
                margin-top: 20px !important; /* ลดจาก 40px */
                text-align: center !important;
            }
            .signature-line {
                display: inline-block !important;
                width: 250px !important; /* ลดจาก 300px */
                border-top: 1px solid #000 !important;
                margin-top: 20px !important; /* ลดจาก 40px */
                padding-top: 8px !important; /* ลดจาก 10px */
                font-size: 11pt !important; /* ลดจาก 12pt */
            }

            /* ปรับปรุงตารางให้กะทัดรัด */
            .results-table,
            .print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 15px 0 !important; /* ลดจาก 20px */
                font-size: 10pt !important; /* ลดจาก 11pt */
                border: 1px solid #000 !important; /* ลดจาก 2px */
                display: table !important;
            }
            .results-table th,
            .print-table th {
                background: #e0e0e0 !important;
                font-weight: bold !important;
                padding: 8px 6px !important; /* ลดจาก 12px 8px */
                border: 1px solid #000 !important;
                text-align: center !important;
                font-family: 'Prompt', sans-serif !important;
            }
            .results-table td,
            .print-table td {
                padding: 6px 5px !important; /* ลดจาก 10px 8px */
                border: 1px solid #000 !important;
                text-align: center !important;
            }

            /* ปรับปรุง test data ให้กะทัดรัด */
            .test-data-print {
                display: block !important;
                background: #f9f9f9 !important;
                padding: 15px !important; /* ลดจาก 20px */
                margin: 15px 0 !important; /* ลดจาก 20px */
                border: 1px solid #ddd !important;
            }

            /* ปรับปรุง analysis box ให้กะทัดรัด */
            .analysis-box {
                background: #fff !important;
                border: 1px solid #e2e8f0 !important;
                border-left: 3px solid var(--primary) !important; /* ลดจาก 5px */
                padding: 15px !important; /* ลดจาก 20px */
                border-radius: 8px !important;
                margin-top: 15px !important; /* ลดจาก 20px */
            }

            /* ปรับปรุง page footer ให้กะทัดรัด */
            .page-footer {
                display: block !important;
                text-align: center !important;
                font-size: 9pt !important; /* ลดจาก 10pt */
                color: #666 !important;
                margin-top: 15px !important; /* ลดจาก 30px */
                padding-top: 10px !important; /* ลดจาก 15px */
                border-top: 1px solid #ddd !important;
            }

            /* บังคับแบ่งหน้าหลังจากหน้าแรก */
            .card:first-of-type {
                page-break-after: always !important;
                margin-bottom: 0 !important;
            }

            /* เพิ่มการควบคุมการแบ่งหน้า */
            .card {
                page-break-inside: avoid !important;
                page-break-before: auto !important;
            }

            /* ปรับปรุงสีสำหรับการพิมพ์ */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            a, a:visited {
                color: #000 !important;
                text-decoration: none !important;
            }

            #printContent * {
                visibility: visible !important;
                display: block !important;
            }
        }
    </style>
</head>
<body>

<div class="container">
    
    <header class="screen-only">
        <h1 class="main-title"><i class="ph ph-stethoscope"></i> Research Statistics Tool</h1>
        <div class="subtitle">โปรแกรมคำนวณสถิติวิจัยทางการพยาบาลและสาธารณสุข (v5.6 Methodology Ed.)</div>
    </header>

    <div class="card screen-only" style="padding: 15px;">
        <div class="test-buttons" style="margin:0;">
            <button class="test-btn active" onclick="selectTest('two-sample')" data-test="two-sample">Independent t-test</button>
            <button class="test-btn" onclick="selectTest('one-sample')" data-test="one-sample">One-Sample t-test</button>
            <button class="test-btn" onclick="selectTest('proportion')" data-test="proportion">Proportion Z-Test</button>
        </div>
    </div>

    <div class="card screen-only">
        <div class="section-title"><i class="ph ph-folder-user"></i> 1. ข้อมูลโครงการวิจัย (Project Info)</div>
        <input type="hidden" id="editId">
        <div class="form-grid">
            <div class="form-group"><label>ชื่อผู้วิจัยหลัก (PI)</label><input type="text" id="piName"></div>
            <div class="form-group"><label>ชื่อเรื่องวิจัย (Title)</label><input type="text" id="titleName"></div>
        </div>
        <div class="form-group">
            <label>ผู้ร่วมวิจัย</label>
            <div class="co-input-wrapper">
                <input type="text" id="coInput" placeholder="พิมพ์ชื่อแล้วกดปุ่ม +" onkeypress="handleCoKey(event)">
                <button type="button" class="add-btn" onclick="addCoResearcher()"><i class="ph ph-plus"></i></button>
            </div>
            <div id="coContainer" class="tag-container"></div>
        </div>

        <div style="height: 1px; background: #e5e7eb; margin: 25px 0;"></div>

        <div class="section-title">
            <i class="ph ph-sliders-horizontal"></i> 2. ตั้งค่าการคำนวณ (Settings)
            <button class="btn btn-edu" style="margin-left: auto; width: auto; font-size: 0.8rem; padding: 6px 15px;" onclick="openModal()">
                <i class="ph ph-book-open"></i> คู่มือสูตรวิจัย (Methodology)
            </button>
        </div>

        <div class="settings-grid">
            <div class="setting-card">
                <div style="font-weight:600; margin-bottom:10px; color:var(--primary);">Confidence Level</div>
                <label style="font-size:0.85rem;">Select Confidence Level</label>
                <select id="confidenceLevel" onchange="updateZValueDisplay(); updateAutoRecommendation();">
                    <option value="0.90">90% CI (Z=1.645)</option>
                    <option value="0.95" selected>95% CI (Z=1.96)</option>
                    <option value="0.99">99% CI (Z=2.576)</option>
                </select>
                <div style="font-size:0.75rem; color:#6b7280; margin-top:8px;" id="ciLevelInfo">
                    กำลังใช้ระดับความเชื่อมั่น: 95%
                </div>
            </div>
            
            <div class="setting-card">
                <div style="font-weight:600; margin-bottom:10px; color:var(--primary); display:flex; align-items:center; gap:5px;">
                    Critical Value Method
                    <i class="ph ph-info info-icon" onclick="showMethodInfo()"></i>
                </div>

                <div class="method-option">
                    <label class="method-label">
                        <input type="radio" name="methodChoice" id="autoMethod" value="auto" checked onclick="selectMethod('auto')">
                        <span style="font-weight:600;">Auto-Select (แนะนำ)</span>
                        <i class="ph ph-info info-icon" onclick="showTooltip('auto')"></i>
                    </label>
                    <div id="autoRecommendation" class="auto-recommendation" style="display:none;">
                        <span id="autoRecommendationText">ระบบจะเลือกวิธีที่เหมาะสมให้อัตโนมัติ</span>
                    </div>
                </div>

                <div class="method-option">
                    <label class="method-label">
                        <input type="radio" name="methodChoice" id="zMethod" value="z" onclick="selectMethod('z')">
                        <span>Z-Distribution <span id="zValueDisplay">(1.96)</span></span>
                        <i class="ph ph-info info-icon" onclick="showTooltip('z')"></i>
                    </label>
                </div>

                <div class="method-option">
                    <label class="method-label">
                        <input type="radio" name="methodChoice" id="tMethod" value="t" onclick="selectMethod('t')">
                        <span>T-Distribution (df-based)</span>
                        <i class="ph ph-info info-icon" onclick="showTooltip('t')"></i>
                    </label>
                </div>

                <div class="critical-value-display" id="criticalValueDisplay" style="display:none;">
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
                        <span style="font-weight:600;">Critical Value:</span>
                        <span id="critValueText">--</span>
                    </div>
                </div>

                <div id="warningMessage" style="display:none; margin-top:10px; padding:10px; background:#fef2f2; border-radius:8px; border-left:4px solid #ef4444;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="ph ph-warning" style="color:#ef4444;"></i>
                        <span style="font-size:0.85rem; font-weight:600;">คำเตือน: Z-Distribution ไม่เหมาะกับ n &lt; 30 — แนะนำใช้ T-Distribution</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="group-box" style="background:#f8fafc; padding:15px; border-radius:12px;">
            <div id="twoSampleInput">
                <div class="form-grid">
                    <div style="background:#eef2ff; padding:15px; border-radius:12px; border:1px solid #c7d2fe;">
                        <strong style="color:#4f46e5; display:block; margin-bottom:10px;">กลุ่มทดลอง (Exp)</strong>
                        <div class="form-group"><label>Mean</label><input type="number" step="any" id="m1"></div>
                        <div class="form-group"><label>SD</label><input type="number" step="any" id="sd1"></div>
                        <div class="form-group"><label>n</label><input type="number" id="n1" oninput="updateAutoRecommendation(); checkZWarning();"></div>
                    </div>
                    <div style="background:#f3f4f6; padding:15px; border-radius:12px; border:1px solid #d1d5db;">
                        <strong style="color:#374151; display:block; margin-bottom:10px;">กลุ่มควบคุม (Ctrl)</strong>
                        <div class="form-group"><label>Mean</label><input type="number" step="any" id="m2"></div>
                        <div class="form-group"><label>SD</label><input type="number" step="any" id="sd2"></div>
                        <div class="form-group"><label>n</label><input type="number" id="n2" oninput="updateAutoRecommendation(); checkZWarning();"></div>
                    </div>
                </div>
            </div>
            <div id="oneSampleInput" style="display:none;">
                <div class="form-grid">
                    <div style="background:#eef2ff; padding:15px; border-radius:12px; border:1px solid #c7d2fe;">
                        <strong style="color:#4f46e5; display:block; margin-bottom:10px;">กลุ่มตัวอย่าง</strong>
                        <div class="form-group"><label>Mean</label><input type="number" step="any" id="mOne" oninput="updateAutoRecommendation(); checkZWarning();"></div>
                        <div class="form-group"><label>SD</label><input type="number" step="any" id="sdOne"></div>
                        <div class="form-group"><label>n</label><input type="number" id="nOne"></div>
                    </div>
                    <div style="background:#f3f4f6; padding:15px; border-radius:12px; border:1px solid #d1d5db;">
                        <strong style="color:#374151; display:block; margin-bottom:10px;">Population</strong>
                        <div class="form-group"><label>Mean (μ₀)</label><input type="number" step="any" id="mu0"></div>
                    </div>
                </div>
            </div>
            <div id="proportionInput" style="display:none;">
                <div class="form-grid">
                    <div style="background:#eef2ff; padding:15px; border-radius:12px; border:1px solid #c7d2fe;">
                        <strong style="color:#4f46e5; display:block; margin-bottom:10px;">กลุ่มที่ 1</strong>
                        <div class="form-group"><label>Events (x₁)</label><input type="number" id="xP1"></div>
                        <div class="form-group"><label>Total (n₁)</label><input type="number" id="nP1" oninput="updateAutoRecommendation(); checkZWarning();"></div>
                    </div>
                    <div style="background:#f3f4f6; padding:15px; border-radius:12px; border:1px solid #d1d5db;">
                        <strong style="color:#374151; display:block; margin-bottom:10px;">กลุ่มที่ 2</strong>
                        <div class="form-group"><label>Events (x₂)</label><input type="number" id="xP2"></div>
                        <div class="form-group"><label>Total (n₂)</label><input type="number" id="nP2" oninput="updateAutoRecommendation(); checkZWarning();"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-outline" onclick="resetForm()"><i class="ph ph-eraser"></i> ล้างค่า</button>
            <button class="btn btn-primary" onclick="calculateStats()"><i class="ph ph-calculator"></i> คำนวณผลลัพธ์</button>
        </div>
    </div>

    <div id="eduModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-family:'Prompt'; color:var(--primary);"><i class="ph ph-books"></i> คู่มือสรุปสูตรและที่มาทางสถิติ</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- เนื้อหาเหมือนไฟล์เดิม ไม่ตัดทอนเพื่อความชัดเจน -->
                <p><strong>WebApp v5.6</strong> – สรุปสูตรหลักที่ใช้ในโปรแกรม</p>
                <hr style="margin:15px 0; opacity:0.2;">

                <h3>1. Independent Samples t-test (Welch)</h3>
                <p><strong>Welch’s t-test (unequal variances)</strong></p>
                <div class="formula-box">
                    \( t = \dfrac{\bar{X}_1 - \bar{X}_2}{\sqrt{\dfrac{s_1^2}{n_1} + \dfrac{s_2^2}{n_2}}} \)
                </div>
                <p><strong>df (Welch–Satterthwaite)</strong></p>
                <div class="formula-box">
                    \( df = \dfrac{\left(\dfrac{s_1^2}{n_1} + \dfrac{s_2^2}{n_2}\right)^2}{\dfrac{\left(\dfrac{s_1^2}{n_1}\right)^2}{n_1-1} + \dfrac{\left(\dfrac{s_2^2}{n_2}\right)^2}{n_2-1}} \)
                </div>

                <h3>2. One-Sample t-test</h3>
                <div class="formula-box">
                    \( t = \dfrac{\bar{X} - \mu_0}{s / \sqrt{n}} \), \( df = n-1 \)
                </div>

                <h3>3. Two-Proportion Z-Test</h3>
                <div class="formula-box">
                    \( Z = \dfrac{p_1 - p_2}{\sqrt{\hat{p}(1-\hat{p})(\dfrac{1}{n_1}+\dfrac{1}{n_2})}} \), 
                    \( \hat{p} = \dfrac{x_1+x_2}{n_1+n_2} \)
                </div>

                <h3>4. Confidence Interval</h3>
                <div class="formula-box">
                    \( CI = \text{Point Estimate} \pm \text{Critical Value} \times SE \)
                </div>

                <h3>5. Effect Size (Cohen’s d)</h3>
                <p><strong>Two-sample (pooled SD)</strong></p>
                <div class="formula-box">
                    \( d = \dfrac{\bar{X}_1 - \bar{X}_2}{SD_{pooled}} \)
                </div>
                <p><strong>One-sample</strong></p>
                <div class="formula-box">
                    \( d = \dfrac{\bar{X} - \mu_0}{s} \)
                </div>
                <ul style="margin-left:25px;">
                    <li>\( |d| &lt; 0.2 \): Negligible</li>
                    <li>\( 0.2 \le |d| &lt; 0.5 \): Small</li>
                    <li>\( 0.5 \le |d| &lt; 0.8 \): Medium</li>
                    <li>\( |d| \ge 0.8 \): Large</li>
                </ul>

                <div style="background:#f1f5f9; padding:20px; border-radius:12px; margin-top:20px;">
                    <strong>References</strong><br>
                    <small>
                        Welch, B. L. (1947). Biometrika.<br>
                        Cohen, J. (1988). Statistical Power Analysis for the Behavioral Sciences.<br>
                        Altman, D. G. et al. (2000). Statistics with Confidence.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div id="methodInfoModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2 style="font-family:'Prompt'; color:var(--primary);"><i class="ph ph-info"></i> Critical Value</h2>
                <span class="close-modal" onclick="closeMethodModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="methodInfoContent"></div>
            </div>
        </div>
    </div>

    <div id="resultSection" class="card result-section screen-only">
        <div class="section-title"><i class="ph ph-chart-pie-slice"></i> 3. ผลการวิเคราะห์ (Results)</div>

        <div class="result-header">
            <div id="pValueCard" class="p-value-card ns">
                <div style="font-size:0.85rem; font-weight:600; color:#666;">P-VALUE</div>
                <div class="display-val" id="pValueDisplay">--</div>
                <div id="pInterpretation" style="font-weight:500;">--</div>
            </div>
            <div class="ci-card">
                <div style="font-size:0.85rem; font-weight:600; color:#666;">
                    <span id="ciLabel">95%</span> CONFIDENCE INTERVAL
                </div>
                <div class="display-val" id="ciDisplay" style="color:var(--primary);">--</div>
                <div id="ciMethodUsed" style="font-size:0.8rem; color:#666;">--</div>
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-item">
                <div class="stat-lbl">Statistic</div>
                <div class="stat-val" id="testStatDisplay">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-lbl">df</div>
                <div class="stat-val" id="dfDisplay">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-lbl">Effect Size d</div>
                <div class="stat-val" id="effectSizeDisplay">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-lbl">Mean Diff</div>
                <div class="stat-val" id="meanDiffDisplay">--</div>
            </div>
        </div>

        <div class="analysis-box">
            <div id="hypoBadge" class="h-badge">--</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <div style="font-size:0.9rem; color:#64748b; font-weight:600;">Effect Size Summary</div>
                    <div style="font-size:1.4rem; font-weight:700;">
                        <span id="esValBox">--</span>
                        <small id="esInterpBox" style="font-size:0.8rem; font-weight:normal;">--</small>
                    </div>
                </div>
                <div>
                    <div style="font-size:0.9rem; color:#64748b; font-weight:600;">Statistical Conclusion</div>
                    <div id="thesisText" style="font-size:0.95rem; font-style:italic;">--</div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button id="btnSave" class="btn btn-save" onclick="saveData()"><i class="ph ph-floppy-disk"></i> บันทึก</button>
            <button class="btn btn-print" onclick="printReport()"><i class="ph ph-printer"></i> PDF</button>
        </div>
    </div>

    <div class="card screen-only history-section">
        <div class="section-title"><i class="ph ph-clock-counter-clockwise"></i> 4. ประวัติการคำนวณ (History)</div>

        <div class="history-controls">
            <input type="text" class="history-search" id="historySearch" placeholder="ค้นหาจากชื่อเรื่อง / PI / วิธีทดสอบ" onkeyup="searchHistory()">
            <button class="clear-history-btn" onclick="clearHistory()"><i class="ph ph-trash"></i> ลบประวัติทั้งหมด</button>
        </div>

        <div class="history-table-container">
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th style="width: 180px;">วันที่-เวลา</th>
                        <th style="width: 200px;">ชื่อเรื่องวิจัย</th>
                        <th style="width: 150px;">PI</th>
                        <th style="width: 120px;">Test</th>
                        <th style="width: 100px;">P-Value</th>
                        <th style="width: 150px;">ผลสรุป</th>
                        <th style="width: 120px;">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        </div>

        <div id="emptyHistory" class="empty-history" style="display:none;">
            <i class="ph ph-clock" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
            <p>ยังไม่มีประวัติการคำนวณ</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">เมื่อคำนวณเสร็จและกดบันทึก ระบบจะแสดงประวัติที่นี่</p>
        </div>

        <div class="history-count" id="historyCount">0 รายการ</div>
    </div>

    <!-- PRINT CONTENT แก้ใหม่ให้ Conclusion หน้าแรก -->
    <div class="print-only" id="printContent">
        <!-- หน้าแรก: สรุปผลวิจัย + ลายเซ็น -->
        <div class="card">
            <div class="print-header">
                <h1>Research Statistics Tool</h1>
                <div class="subtitle">v5.6 Methodology Ed.</div>
            </div>

            <div class="print-meta">
                <div>วันที่วิเคราะห์: <span id="printDate">--</span></div>
                <div>ผู้วิจัยหลัก: <span id="printUser">--</span></div>
            </div>

            <div class="print-report-title">
                รายงานสรุปผลการวิเคราะห์สถิติสำหรับงานวิจัยทางการพยาบาล
            </div>

            <div class="project-info-print" id="projectInfoPrint">
                <p><strong>ชื่อเรื่องวิจัย:</strong> <span id="printTitle">--</span></p>
                <p><strong>ผู้วิจัยหลัก (PI):</strong> <span id="printPI">--</span></p>
                <p><strong>ผู้ร่วมวิจัย:</strong> <span id="printCoResearchers">--</span></p>
                <p><strong>ประเภทการทดสอบ:</strong> <span id="printTestType">--</span></p>
                <p><strong>วันที่คำนวณ:</strong> <span id="printAnalysisDate">--</span></p>
            </div>

            <div class="conclusion-section">
                <h3>สรุปผลการวิจัย (Conclusion)</h3>
                <div class="conclusion-text" id="printConclusionText">--</div>

                <div class="signature-section">
                    <div class="signature-line">
                        ลงชื่อ..........................................................<br>
                        ( ผู้วิจัยหลัก )<br>
                        วันที่..........................................................
                    </div>
                </div>
            </div>

            <div class="page-footer">
                <p>Research Statistics Tool v5.6 – Specialist Nurse 2026</p>
            </div>
        </div>

        <!-- หน้าที่สอง: ข้อมูลดิบ + ผลตัวเลข + settings -->
        <div class="card" style="page-break-before: always;">
            <div class="section-title">2. ข้อมูลดิบที่ใช้ในการวิเคราะห์</div>
            <div id="testDataPrint" class="test-data-print"></div>

            <div class="section-title" style="margin-top:25px;">3. ผลการวิเคราะห์เชิงสถิติ</div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>การทดสอบ</th>
                        <th>ค่าสถิติ</th>
                        <th>df</th>
                        <th>P-value</th>
                        <th>Effect Size</th>
                        <th id="printCiHeader">95% CI</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="printTestName">--</td>
                        <td id="printTestStat">--</td>
                        <td id="printDf">--</td>
                        <td id="printPValue">--</td>
                        <td id="printEffectSize">--</td>
                        <td id="printCi">--</td>
                    </tr>
                </tbody>
            </table>

            <div class="analysis-box">
                <div id="printHypoBadge" class="h-badge">--</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <div style="font-size:0.9rem; color:#64748b; font-weight:600;">Effect Size Summary</div>
                        <div style="font-size:1.4rem; font-weight:700;">
                            <span id="printEsValBox">--</span>
                            <small id="printEsInterpBox" style="font-size:0.8rem; font-weight:normal;">--</small>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.9rem; color:#64748b; font-weight:600;">Statistical Conclusion</div>
                        <div id="printThesisText" style="font-size:0.95rem; font-style:italic;">--</div>
                    </div>
                </div>
            </div>

            <div class="section-title" style="margin-top:25px;">4. Settings</div>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>รายละเอียด</th>
                    </tr>
                </thead>
                <tbody id="printSettingsTable">
                    <tr>
                        <td>Confidence Level</td>
                        <td>95% (Alpha 0.05)</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>

            <div class="page-footer">
                <p>Research Statistics Tool v5.6 – Specialist Nurse 2026</p>
            </div>
        </div>
    </div>

    <footer class="app-footer screen-only">
        <div>Developed by <b>Specialist Nurse</b><br>Research Tool v5.6 © 2026</div>
    </footer>
</div>

<script>
    function openModal() {
        document.getElementById('eduModal').style.display = 'block';
        if (window.MathJax) { MathJax.typeset(); }
    }
    function closeModal() {
        document.getElementById('eduModal').style.display = 'none';
    }
    function closeMethodModal() {
        document.getElementById('methodInfoModal').style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target === document.getElementById('eduModal')) closeModal();
        if (event.target === document.getElementById('methodInfoModal')) closeMethodModal();
    };

    let researchData = JSON.parse(localStorage.getItem('researchData') || '[]');
    let coResearchers = [];
    let currentTestType = 'two-sample';
    let currentMethod = 'auto';
    let lastCalculation = null;
    let isEditing = false;
    let currentEditId = null;

    const zCriticalValues = {
        0.90: 1.645,
        0.95: 1.96,
        0.99: 2.576
    };

    function handleCoKey(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addCoResearcher();
        }
    }
    function addCoResearcher() {
        const val = document.getElementById('coInput').value.trim();
        if (val && !coResearchers.includes(val)) {
            coResearchers.push(val);
            renderCoTags();
        }
        document.getElementById('coInput').value = '';
    }
    function removeCo(i) {
        coResearchers.splice(i, 1);
        renderCoTags();
    }
    function renderCoTags() {
        const c = document.getElementById('coContainer');
        c.innerHTML = '';
        coResearchers.forEach((n, i) => {
            c.innerHTML += `<div class="tag">${n} <i class="ph ph-x" onclick="removeCo(${i})"></i></div>`;
        });
    }

    function selectTest(type) {
        currentTestType = type;
        document.querySelectorAll('.test-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.test === type);
        });
        document.getElementById('twoSampleInput').style.display = type === 'two-sample' ? 'block' : 'none';
        document.getElementById('oneSampleInput').style.display = type === 'one-sample' ? 'block' : 'none';
        document.getElementById('proportionInput').style.display = type === 'proportion' ? 'block' : 'none';
        document.getElementById('resultSection').style.display = 'none';
        updateAutoRecommendation();
        checkZWarning();
    }

    function selectMethod(method) {
        currentMethod = method;
        updateMethodUI();
        updateZValueDisplay();
        updateAutoRecommendation();
        checkZWarning();
        if (document.getElementById('resultSection').style.display === 'block' && lastCalculation) {
            calculateStats();
        }
    }

    function getSelectedMethod() {
        if (currentMethod === 'auto') {
            let n1, n2;
            if (currentTestType === 'two-sample') {
                n1 = parseFloat(document.getElementById('n1').value);
                n2 = parseFloat(document.getElementById('n2').value);
            } else if (currentTestType === 'one-sample') {
                n1 = parseFloat(document.getElementById('nOne').value);
                n2 = null;
            } else {
                n1 = parseFloat(document.getElementById('nP1').value);
                n2 = parseFloat(document.getElementById('nP2').value);
            }
            if (isNaN(n1) || (n2 !== null && isNaN(n2))) return 'z';
            const avgN = n2 ? (n1 + n2) / 2 : n1;
            if (avgN >= 30) return 'z';
            return 't';
        }
        return currentMethod;
    }

    function updateMethodUI() {
        const autoRecDiv = document.getElementById('autoRecommendation');
        const critValueDiv = document.getElementById('criticalValueDisplay');
        if (currentMethod === 'auto') {
            autoRecDiv.style.display = 'block';
            critValueDiv.style.display = 'none';
        } else {
            autoRecDiv.style.display = 'none';
            critValueDiv.style.display = 'block';
        }
    }

    function updateZValueDisplay() {
        const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
        const zValue = zCriticalValues[confidenceLevel];
        const ciPercent = Math.round(confidenceLevel * 100);
        document.getElementById('zValueDisplay').textContent = `(${zValue.toFixed(3)})`;
        document.getElementById('ciLabel').textContent = `${ciPercent}%`;
        document.getElementById('ciLevelInfo').textContent = `กำลังใช้ระดับความเชื่อมั่น: ${ciPercent}%`;
        document.getElementById('printCiHeader').textContent = `${ciPercent}% CI`;
    }

    function updateAutoRecommendation() {
        const recText = document.getElementById('autoRecommendationText');
        if (currentMethod !== 'auto') return;
        let n1, n2;
        if (currentTestType === 'two-sample') {
            n1 = parseFloat(document.getElementById('n1').value);
            n2 = parseFloat(document.getElementById('n2').value);
        } else if (currentTestType === 'one-sample') {
            n1 = parseFloat(document.getElementById('nOne').value);
            n2 = null;
        } else {
            n1 = parseFloat(document.getElementById('nP1').value);
            n2 = parseFloat(document.getElementById('nP2').value);
        }
        if (!isNaN(n1) && (n2 === null || !isNaN(n2))) {
            const avgN = n2 ? (n1 + n2) / 2 : n1;
            if (avgN >= 30) {
                recText.textContent = `แนะนำใช้ Z-Distribution (n เฉลี่ย = ${avgN.toFixed(0)} ≥ 30)`;
            } else {
                recText.textContent = `แนะนำใช้ T-Distribution (n เฉลี่ย = ${avgN.toFixed(0)} < 30)`;
            }
        } else {
            recText.textContent = 'ระบบจะเลือกวิธีที่เหมาะสมให้อัตโนมัติเมื่อกรอก n ครบ';
        }
    }

    function checkZWarning() {
        const warningDiv = document.getElementById('warningMessage');
        if (currentMethod !== 'z') {
            warningDiv.style.display = 'none';
            return;
        }
        let n1, n2;
        if (currentTestType === 'two-sample') {
            n1 = parseFloat(document.getElementById('n1').value);
            n2 = parseFloat(document.getElementById('n2').value);
        } else if (currentTestType === 'one-sample') {
            n1 = parseFloat(document.getElementById('nOne').value);
            n2 = null;
        } else {
            n1 = parseFloat(document.getElementById('nP1').value);
            n2 = parseFloat(document.getElementById('nP2').value);
        }
        let show = false;
        if (!isNaN(n1) && n1 < 30) show = true;
        if (n2 !== null && !isNaN(n2) && n2 < 30) show = true;
        warningDiv.style.display = show ? 'block' : 'none';
    }

    function normalCDF(z) {
        const t = 1 / (1 + 0.2316419 * Math.abs(z));
        const d = 0.3989423 * Math.exp(-z * z / 2);
        const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return z > 0 ? 1 - p : p;
    }

    function getCriticalValue(df, confidenceLevel) {
        const method = getSelectedMethod();
        if (method === 'z') {
            return zCriticalValues[confidenceLevel];
        }
        if (df <= 0) return zCriticalValues[confidenceLevel];
        let tCrit;
        if (confidenceLevel === 0.90) {
            if (df >= 120) tCrit = 1.645;
            else if (df >= 60) tCrit = 1.671;
            else if (df >= 40) tCrit = 1.684;
            else if (df >= 30) tCrit = 1.697;
            else if (df >= 20) tCrit = 1.725;
            else if (df >= 15) tCrit = 1.753;
            else if (df >= 10) tCrit = 1.812;
            else if (df >= 5) tCrit = 1.943;
            else tCrit = 2.015;
        } else if (confidenceLevel === 0.95) {
            if (df >= 120) tCrit = 1.96;
            else if (df >= 60) tCrit = 2.000;
            else if (df >= 40) tCrit = 2.021;
            else if (df >= 30) tCrit = 2.042;
            else if (df >= 20) tCrit = 2.086;
            else if (df >= 15) tCrit = 2.131;
            else if (df >= 10) tCrit = 2.228;
            else if (df >= 5) tCrit = 2.571;
            else tCrit = 2.920;
        } else if (confidenceLevel === 0.99) {
            if (df >= 120) tCrit = 2.576;
            else if (df >= 60) tCrit = 2.660;
            else if (df >= 40) tCrit = 2.704;
            else if (df >= 30) tCrit = 2.750;
            else if (df >= 20) tCrit = 2.845;
            else if (df >= 15) tCrit = 2.947;
            else if (df >= 10) tCrit = 3.169;
            else if (df >= 5) tCrit = 4.032;
            else tCrit = 4.303;
        } else {
            tCrit = zCriticalValues[0.95];
        }
        return tCrit;
    }

    function calculateStats() {
        const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
        const method = getSelectedMethod();
        let res = {};
        const ciLevel = Math.round(confidenceLevel * 100);
        document.getElementById('ciLabel').textContent = `${ciLevel}%`;
        document.getElementById('ciLevelInfo').textContent = `กำลังใช้ระดับความเชื่อมั่น: ${ciLevel}%`;

        if (currentTestType === 'two-sample') {
            const m1 = parseFloat(document.getElementById('m1').value),
                  sd1 = parseFloat(document.getElementById('sd1').value),
                  n1 = parseFloat(document.getElementById('n1').value);
            const m2 = parseFloat(document.getElementById('m2').value),
                  sd2 = parseFloat(document.getElementById('sd2').value),
                  n2 = parseFloat(document.getElementById('n2').value);
            if (isNaN(n1) || isNaN(n2)) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            const diff = m1 - m2;
            const se = Math.sqrt((sd1 ** 2 / n1) + (sd2 ** 2 / n2));
            const tStat = diff / se;
            const df = ((sd1 ** 2 / n1) + (sd2 ** 2 / n2)) ** 2 /
                (((sd1 ** 2 / n1) ** 2 / (n1 - 1)) + ((sd2 ** 2 / n2) ** 2 / (n2 - 1)));
            const crit = getCriticalValue(df, confidenceLevel);
            document.getElementById('critValueText').textContent = crit.toFixed(3);
            res = {
                stat: tStat,
                df: df,
                p: 2 * (1 - normalCDF(Math.abs(tStat))),
                lower: diff - crit * se,
                upper: diff + crit * se,
                d: diff / Math.sqrt(((n1 - 1) * sd1 ** 2 + (n2 - 1) * sd2 ** 2) / (n1 + n2 - 2)),
                diff: diff,
                crit: crit,
                testType: 'two-sample',
                data: { m1, sd1, n1, m2, sd2, n2 }
            };
        } else if (currentTestType === 'one-sample') {
            const m = parseFloat(document.getElementById('mOne').value),
                  sd = parseFloat(document.getElementById('sdOne').value),
                  n = parseFloat(document.getElementById('nOne').value),
                  mu0 = parseFloat(document.getElementById('mu0').value);
            if (isNaN(n)) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            const diff = m - mu0;
            const se = sd / Math.sqrt(n);
            const tStat = diff / se;
            const df = n - 1;
            const crit = getCriticalValue(df, confidenceLevel);
            document.getElementById('critValueText').textContent = crit.toFixed(3);
            res = {
                stat: tStat,
                df: df,
                p: 2 * (1 - normalCDF(Math.abs(tStat))),
                lower: diff - crit * se,
                upper: diff + crit * se,
                d: diff / sd,
                diff: diff,
                crit: crit,
                testType: 'one-sample',
                data: { m, sd, n, mu0 }
            };
        } else {
            const x1 = parseFloat(document.getElementById('xP1').value),
                  n1 = parseFloat(document.getElementById('nP1').value),
                  x2 = parseFloat(document.getElementById('xP2').value),
                  n2 = parseFloat(document.getElementById('nP2').value);
            if (isNaN(n1) || isNaN(n2)) { alert('กรุณากรอกข้อมูลให้ครบ'); return; }
            const p1 = x1 / n1;
            const p2 = x2 / n2;
            const p = (x1 + x2) / (n1 + n2);
            const se = Math.sqrt(p * (1 - p) * (1 / n1 + 1 / n2));
            const zStat = (p1 - p2) / se;
            const df = n1 + n2 - 2;
            const crit = getCriticalValue(df, confidenceLevel);
            document.getElementById('critValueText').textContent = crit.toFixed(3);
            const diff = p1 - p2;
            res = {
                stat: zStat,
                df: df,
                p: 2 * (1 - normalCDF(Math.abs(zStat))),
                lower: diff - crit * se,
                upper: diff + crit * se,
                d: null,
                diff: diff,
                crit: crit,
                testType: 'proportion',
                data: { x1, n1, x2, n2, p1, p2 }
            };
        }

        lastCalculation = res;
        renderResults(res);
        document.getElementById('resultSection').style.display = 'block';
    }

    function renderResults(res) {
        const alpha = 1 - parseFloat(document.getElementById('confidenceLevel').value);
        const sig = res.p < alpha;
        const pCard = document.getElementById('pValueCard');
        pCard.classList.remove('sig', 'ns');
        pCard.classList.add(sig ? 'sig' : 'ns');
        document.getElementById('pValueDisplay').textContent = res.p < 0.001 ? '< .001' : res.p.toFixed(3);
        document.getElementById('pInterpretation').textContent = sig ? 'Significant' : 'Not Significant';

        document.getElementById('ciDisplay').textContent = `[${res.lower.toFixed(2)}, ${res.upper.toFixed(2)}]`;
        const methodUsed = getSelectedMethod();
        let methodText = '';
        if (methodUsed === 'z') methodText = 'Z-Distribution';
        else if (methodUsed === 't') methodText = 'T-Distribution';
        else methodText = 'Auto-Selected';
        document.getElementById('ciMethodUsed').textContent =
            `${methodText} | Critical Value = ${res.crit.toFixed(3)}`;

        document.getElementById('testStatDisplay').textContent = res.stat.toFixed(3);
        document.getElementById('dfDisplay').textContent = res.df ? res.df.toFixed(2) : '--';
        document.getElementById('meanDiffDisplay').textContent = res.diff.toFixed(3);

        let es = Math.abs(res.d || 0), interp = "--";
        if (res.d != null) {
            if (es < 0.2) interp = "Negligible";
            else if (es < 0.5) interp = "Small";
            else if (es < 0.8) interp = "Medium";
            else interp = "Large";
        }
        document.getElementById('effectSizeDisplay').textContent = res.d != null ? es.toFixed(2) : '--';
        document.getElementById('esValBox').textContent = res.d != null ? es.toFixed(2) : '--';
        document.getElementById('esInterpBox').textContent = interp;

        const hypoBadge = document.getElementById('hypoBadge');
        hypoBadge.innerText = sig ? 'Reject H₀ / Accept H₁' : 'Accept H₀';
        hypoBadge.className = sig ? 'h-badge h-reject' : 'h-badge h-accept';

        const ciLevel = Math.round(parseFloat(document.getElementById('confidenceLevel').value) * 100);
        document.getElementById('thesisText').innerText =
            `ผลการทดสอบ ${sig ? 'มี' : 'ไม่พบ'}ความแตกต่างอย่างมีนัยสำคัญที่ระดับ ${ciLevel}% (p = ${res.p.toFixed(3)}, α = ${alpha.toFixed(3)})`;
    }

    function resetForm() {
        document.getElementById('piName').value = '';
        document.getElementById('titleName').value = '';
        coResearchers = [];
        renderCoTags();
        ['m1','sd1','n1','m2','sd2','n2','mOne','sdOne','nOne','mu0','xP1','nP1','xP2','nP2'].forEach(id=>{
            const el=document.getElementById(id); if(el) el.value='';
        });
        document.getElementById('resultSection').style.display = 'none';
        lastCalculation = null;
        isEditing = false;
        currentEditId = null;
        document.getElementById('editId').value = '';
        document.getElementById('btnSave').innerHTML = '<i class="ph ph-floppy-disk"></i> บันทึก';
        document.getElementById('btnSave').classList.remove('editing');
    }

    function getTestTypeName(testType) {
        switch(testType) {
            case 'two-sample': return 'Independent t-test (2 กลุ่มอิสระ)';
            case 'one-sample': return 'One-Sample t-test (กลุ่มเดียว)';
            case 'proportion': return 'Proportion Z-Test (2 สัดส่วน)';
            default: return 'ไม่ทราบประเภท';
        }
    }

    function generateConclusionText() {
        const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
        const ciLevel = Math.round(confidenceLevel * 100);
        const sig = lastCalculation.p < (1 - confidenceLevel);
        const testName = getTestTypeName(currentTestType);

        let conclusion = `จากการวิเคราะห์ด้วย ${testName} `;
        if (sig) {
            conclusion += `พบว่ามีความแตกต่างอย่างมีนัยสำคัญทางสถิติที่ระดับ ${ciLevel}% (p = ${lastCalculation.p < 0.001 ? '< .001' : lastCalculation.p.toFixed(3)}). `;
        } else {
            conclusion += `ไม่พบความแตกต่างอย่างมีนัยสำคัญทางสถิติที่ระดับ ${ciLevel}% (p = ${lastCalculation.p.toFixed(3)}). `;
        }
        conclusion += `ช่วงความเชื่อมั่น ${ciLevel}% อยู่ที่ [${lastCalculation.lower.toFixed(2)}, ${lastCalculation.upper.toFixed(2)}]. `;
        if (lastCalculation.d) {
            const es = Math.abs(lastCalculation.d);
            let esLevel = "ต่ำมาก";
            if(es >= 0.2) esLevel = "ต่ำ";
            if(es >= 0.5) esLevel = "ปานกลาง";
            if(es >= 0.8) esLevel = "สูง";
            conclusion += `ขนาดอิทธิพล (Cohen's d) เท่ากับ ${es.toFixed(2)} ซึ่งจัดอยู่ในระดับ ${esLevel}.`;
        }
        return conclusion;
    }

    function saveData() {
        if (!lastCalculation) {
            alert('กรุณาคำนวณผลลัพธ์ก่อนบันทึก');
            return;
        }
        const piName = document.getElementById('piName').value || 'ไม่ระบุชื่อ';
        const titleName = document.getElementById('titleName').value || 'ไม่ระบุชื่อเรื่อง';
        const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
        const timestamp = new Date().toLocaleString('th-TH');

        const item = {
            id: isEditing && currentEditId ? currentEditId : Date.now(),
            piName,
            titleName,
            coResearchers: [...coResearchers],
            testType: currentTestType,
            confidenceLevel,
            method: currentMethod,
            calculation: lastCalculation,
            timestamp
        };

        if (isEditing) {
            researchData = researchData.map(r => r.id === currentEditId ? item : r);
        } else {
            researchData.push(item);
        }

        localStorage.setItem('researchData', JSON.stringify(researchData));
        loadHistory();
        isEditing = false;
        currentEditId = null;
        document.getElementById('editId').value = '';
        document.getElementById('btnSave').innerHTML = '<i class="ph ph-floppy-disk"></i> บันทึก';
        document.getElementById('btnSave').classList.remove('editing');
        alert('บันทึกข้อมูลเรียบร้อยแล้ว');
    }

    function loadHistory() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        if (!researchData.length) {
            document.getElementById('emptyHistory').style.display = 'block';
            document.getElementById('historyCount').textContent = '0 รายการ';
            return;
        }
        document.getElementById('emptyHistory').style.display = 'none';
        researchData.forEach(item => {
            const sig = item.calculation.p < (1 - item.confidenceLevel);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.timestamp}</td>
                <td>${item.titleName}</td>
                <td>${item.piName}</td>
                <td>${getTestTypeName(item.testType)}</td>
                <td>${item.calculation.p < 0.001 ? '< .001' : item.calculation.p.toFixed(3)}</td>
                <td>${sig ? 'มีนัยสำคัญ' : 'ไม่พบ นยส.'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view-btn" onclick="viewHistoryItem(${item.id})"><i class="ph ph-eye"></i> ดู</button>
                        <button class="action-btn edit-btn" onclick="editHistoryItem(${item.id})"><i class="ph ph-pencil"></i> แก้ไข</button>
                        <button class="action-btn print-btn" onclick="printHistoryItem(${item.id})"><i class="ph ph-printer"></i> PDF</button>
                        <button class="action-btn delete-btn" onclick="deleteHistoryItem(${item.id})"><i class="ph ph-trash"></i> ลบ</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('historyCount').textContent = `${researchData.length} รายการ`;
    }

    function searchHistory() {
        const q = document.getElementById('historySearch').value.toLowerCase();
        const rows = document.querySelectorAll('#historyTableBody tr');
        let count = 0;
        rows.forEach(r => {
            const text = r.innerText.toLowerCase();
            if (text.includes(q)) {
                r.style.display = '';
                count++;
            } else {
                r.style.display = 'none';
            }
        });
        document.getElementById('historyCount').textContent = `${count} รายการ`;
    }

    function clearHistory() {
        if (!confirm('ต้องการลบประวัติทั้งหมดหรือไม่?')) return;
        researchData = [];
        localStorage.removeItem('researchData');
        loadHistory();
    }

    function viewHistoryItem(id) {
        const item = researchData.find(x => x.id === id);
        if (!item) return;
        alert(`โครงการ: ${item.titleName}\nPI: ${item.piName}\nP-value: ${item.calculation.p.toFixed(3)}`);
    }

    function editHistoryItem(id) {
        const item = researchData.find(item => item.id === id);
        if (!item) return;

        document.getElementById('piName').value = item.piName;
        document.getElementById('titleName').value = item.titleName;
        coResearchers = [...item.coResearchers];
        renderCoTags();
        selectTest(item.testType);

        if (item.testType === 'two-sample') {
            const d = item.calculation.data;
            document.getElementById('m1').value = d.m1;
            document.getElementById('sd1').value = d.sd1;
            document.getElementById('n1').value = d.n1;
            document.getElementById('m2').value = d.m2;
            document.getElementById('sd2').value = d.sd2;
            document.getElementById('n2').value = d.n2;
        } else if (item.testType === 'one-sample') {
            const d = item.calculation.data;
            document.getElementById('mOne').value = d.m;
            document.getElementById('sdOne').value = d.sd;
            document.getElementById('nOne').value = d.n;
            document.getElementById('mu0').value = d.mu0;
        } else {
            const d = item.calculation.data;
            document.getElementById('xP1').value = d.x1;
            document.getElementById('nP1').value = d.n1;
            document.getElementById('xP2').value = d.x2;
            document.getElementById('nP2').value = d.n2;
        }

        document.getElementById('confidenceLevel').value = item.confidenceLevel;
        updateZValueDisplay();

        currentMethod = item.method;
        document.getElementById(`${item.method}Method`).checked = true;
        selectMethod(item.method);

        lastCalculation = item.calculation;
        renderResults(lastCalculation);
        document.getElementById('resultSection').style.display = 'block';

        isEditing = true;
        currentEditId = item.id;
        document.getElementById('editId').value = item.id;
        document.getElementById('btnSave').innerHTML = '<i class="ph ph-floppy-disk"></i> อัปเดตข้อมูล';
        document.getElementById('btnSave').classList.add('editing');

        document.querySelector('.card').scrollIntoView({behavior: 'smooth'});
    }

    function deleteHistoryItem(id) {
        if (!confirm('ต้องการลบรายการนี้หรือไม่?')) return;
        researchData = researchData.filter(item => item.id !== id);
        localStorage.setItem('researchData', JSON.stringify(researchData));
        loadHistory();
    }

    function printReport() {
        if (!lastCalculation) {
            alert('กรุณาคำนวณผลลัพธ์ก่อนพิมพ์รายงาน');
            return;
        }
        preparePrintData();
        setTimeout(() => {
            window.print();
        }, 100);
    }

    function printHistoryItem(id) {
        const item = researchData.find(item => item.id === id);
        if (!item) return;
        
        // เตรียมข้อมูลสำหรับพิมพ์จากประวัติ
        lastCalculation = item.calculation;
        currentTestType = item.testType;
        coResearchers = [...item.coResearchers];
        
        // เตรียมข้อมูลสำหรับพิมพ์
        const now = new Date();
        document.getElementById('printDate').textContent = item.timestamp;
        document.getElementById('printUser').textContent = item.piName;
        document.getElementById('printPI').textContent = item.piName;
        document.getElementById('printTitle').textContent = item.titleName;
        document.getElementById('printCoResearchers').textContent = item.coResearchers.join(', ') || '-';
        document.getElementById('printTestType').textContent = getTestTypeName(item.testType);
        document.getElementById('printAnalysisDate').textContent = item.timestamp;

        // เตรียม test data
        let testDataHTML = '';
        const d = item.calculation.data;
        if (d && item.testType === 'two-sample') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Mean</th><th>SD</th><th>n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Experimental</td><td>${d.m1}</td><td>${d.sd1}</td><td>${d.n1}</td></tr>
                        <tr><td>Control</td><td>${d.m2}</td><td>${d.sd2}</td><td>${d.n2}</td></tr>
                    </tbody>
                </table>`;
        } else if (d && item.testType === 'one-sample') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Mean</th><th>SD</th><th>n</th><th>μ₀</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Sample</td><td>${d.m}</td><td>${d.sd}</td><td>${d.n}</td><td>${d.mu0}</td></tr>
                    </tbody>
                </table>`;
        } else if (d && item.testType === 'proportion') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Events (x)</th><th>Total (n)</th><th>Proportion (p)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>${d.x1}</td><td>${d.n1}</td><td>${d.p1 ? d.p1.toFixed(3) : (d.x1/d.n1).toFixed(3)}</td></tr>
                        <tr><td>2</td><td>${d.x2}</td><td>${d.n2}</td><td>${d.p2 ? d.p2.toFixed(3) : (d.x2/d.n2).toFixed(3)}</td></tr>
                    </tbody>
                </table>`;
        }
        document.getElementById('testDataPrint').innerHTML = testDataHTML;

        // เตรียมผลลัพธ์
        const ciLevel = Math.round(item.confidenceLevel * 100);
        const alpha = 1 - item.confidenceLevel;
        const res = item.calculation;
        if (res) {
            const sig = res.p < alpha;
            document.getElementById('printTestName').textContent = getTestTypeName(item.testType);
            document.getElementById('printTestStat').textContent = res.stat.toFixed(3);
            document.getElementById('printDf').textContent = res.df ? res.df.toFixed(2) : '--';
            document.getElementById('printPValue').textContent = res.p < 0.001 ? '< .001' : res.p.toFixed(3);
            document.getElementById('printEffectSize').textContent = res.d ? Math.abs(res.d).toFixed(2) : '--';
            document.getElementById('printCi').textContent = `[${res.lower.toFixed(2)}, ${res.upper.toFixed(2)}]`;
            document.getElementById('printCiHeader').textContent = `${ciLevel}% CI`;

            const printHypoBadge = document.getElementById('printHypoBadge');
            printHypoBadge.innerText = sig ? 'Reject H₀ / Accept H₁' : 'Accept H₀';
            printHypoBadge.className = sig ? 'h-badge h-reject' : 'h-badge h-accept';

            let es = Math.abs(res.d || 0), interp = "Negligible";
            if (es >= 0.2) interp = "Small";
            if (es >= 0.5) interp = "Medium";
            if (es >= 0.8) interp = "Large";
            document.getElementById('printEsValBox').innerText = es.toFixed(2);
            document.getElementById('printEsInterpBox').innerText = interp;
            document.getElementById('printThesisText').innerText =
                `ผลการทดสอบ ${sig ? 'มี' : 'ไม่พบ'}ความแตกต่างอย่างมีนัยสำคัญที่ระดับ ${ciLevel}% (p = ${res.p.toFixed(3)}, α = ${alpha.toFixed(3)})`;

            const methodText = item.method === 'z' ? 'Z-Distribution'
                : item.method === 't' ? 'T-Distribution' : 'Auto-Selected';

            const settingsTable = document.getElementById('printSettingsTable');
            settingsTable.innerHTML = `
                <tr>
                    <td>ระดับความเชื่อมั่น</td>
                    <td>${ciLevel}%</td>
                    <td>ค่า Alpha = ${alpha.toFixed(3)}</td>
                </tr>
                <tr>
                    <td>วิธีการคำนวณ</td>
                    <td>${methodText}</td>
                    <td>${item.method === 'auto' ? 'เลือกวิธีโดยอัตโนมัติ' : 'เลือกวิธีด้วยตนเอง'}</td>
                </tr>
                <tr>
                    <td>Critical Value</td>
                    <td>${res.crit.toFixed(3)}</td>
                    <td>ใช้สำหรับคำนวณช่วงความเชื่อมั่น</td>
                </tr>`;
        }

        // สรุปผล
        const sig = item.calculation.p < (1 - item.confidenceLevel);
        const testName = getTestTypeName(item.testType);
        let conclusion = `จากการวิเคราะห์ด้วย ${testName} `;
        if (sig) {
            conclusion += `พบว่ามีความแตกต่างอย่างมีนัยสำคัญทางสถิติที่ระดับ ${ciLevel}% (p = ${item.calculation.p < 0.001 ? '< .001' : item.calculation.p.toFixed(3)}). `;
        } else {
            conclusion += `ไม่พบความแตกต่างอย่างมีนัยสำคัญทางสถิติที่ระดับ ${ciLevel}% (p = ${item.calculation.p.toFixed(3)}). `;
        }
        conclusion += `ช่วงความเชื่อมั่น ${ciLevel}% อยู่ที่ [${item.calculation.lower.toFixed(2)}, ${item.calculation.upper.toFixed(2)}]. `;
        if (item.calculation.d) {
            const es = Math.abs(item.calculation.d);
            let esLevel = "ต่ำมาก";
            if(es >= 0.2) esLevel = "ต่ำ";
            if(es >= 0.5) esLevel = "ปานกลาง";
            if(es >= 0.8) esLevel = "สูง";
            conclusion += `ขนาดอิทธิพล (Cohen's d) เท่ากับ ${es.toFixed(2)} ซึ่งจัดอยู่ในระดับ ${esLevel}.`;
        }
        document.getElementById('printConclusionText').textContent = conclusion;

        // พิมพ์
        setTimeout(() => {
            window.print();
        }, 100);
    }

    function preparePrintData() {
        const now = new Date();
        document.getElementById('printDate').textContent = now.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const pi = document.getElementById('piName').value || 'ไม่ระบุชื่อ';
        const title = document.getElementById('titleName').value || '-';

        document.getElementById('printUser').textContent = pi;
        document.getElementById('printPI').textContent = pi;
        document.getElementById('printTitle').textContent = title;
        document.getElementById('printCoResearchers').textContent = (coResearchers || []).join(', ') || '-';
        document.getElementById('printTestType').textContent = getTestTypeName(currentTestType);
        document.getElementById('printAnalysisDate').textContent = now.toLocaleDateString('th-TH');

        let testDataHTML = '';
        const d = lastCalculation ? lastCalculation.data : null;
        if (d && currentTestType === 'two-sample') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Mean</th><th>SD</th><th>n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Experimental</td><td>${d.m1}</td><td>${d.sd1}</td><td>${d.n1}</td></tr>
                        <tr><td>Control</td><td>${d.m2}</td><td>${d.sd2}</td><td>${d.n2}</td></tr>
                    </tbody>
                </table>`;
        } else if (d && currentTestType === 'one-sample') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Mean</th><th>SD</th><th>n</th><th>μ₀</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Sample</td><td>${d.m}</td><td>${d.sd}</td><td>${d.n}</td><td>${d.mu0}</td></tr>
                    </tbody>
                </table>`;
        } else if (d && currentTestType === 'proportion') {
            testDataHTML = `
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>กลุ่ม</th><th>Events (x)</th><th>Total (n)</th><th>Proportion (p)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>${d.x1}</td><td>${d.n1}</td><td>${d.p1.toFixed(3)}</td></tr>
                        <tr><td>2</td><td>${d.x2}</td><td>${d.n2}</td><td>${d.p2.toFixed(3)}</td></tr>
                    </tbody>
                </table>`;
        }
        document.getElementById('testDataPrint').innerHTML = testDataHTML;

        const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value || '0.95');
        const ciLevel = Math.round(confidenceLevel * 100);
        const alpha = 1 - confidenceLevel;
        const res = lastCalculation;
        if (res) {
            const sig = res.p < alpha;
            document.getElementById('printTestName').textContent = getTestTypeName(currentTestType);
            document.getElementById('printTestStat').textContent = res.stat.toFixed(3);
            document.getElementById('printDf').textContent = res.df ? res.df.toFixed(2) : '--';
            document.getElementById('printPValue').textContent = res.p < 0.001 ? '< .001' : res.p.toFixed(3);
            document.getElementById('printEffectSize').textContent = res.d ? Math.abs(res.d).toFixed(2) : '--';
            document.getElementById('printCi').textContent = `[${res.lower.toFixed(2)}, ${res.upper.toFixed(2)}]`;
            document.getElementById('printCiHeader').textContent = `${ciLevel}% CI`;

            const printHypoBadge = document.getElementById('printHypoBadge');
            printHypoBadge.innerText = sig ? 'Reject H₀ / Accept H₁' : 'Accept H₀';
            printHypoBadge.className = sig ? 'h-badge h-reject' : 'h-badge h-accept';

            let es = Math.abs(res.d || 0), interp = "Negligible";
            if (es >= 0.2) interp = "Small";
            if (es >= 0.5) interp = "Medium";
            if (es >= 0.8) interp = "Large";
            document.getElementById('printEsValBox').innerText = es.toFixed(2);
            document.getElementById('printEsInterpBox').innerText = interp;
            document.getElementById('printThesisText').innerText =
                `ผลการทดสอบ ${sig ? 'มี' : 'ไม่พบ'}ความแตกต่างอย่างมีนัยสำคัญที่ระดับ ${ciLevel}% (p = ${res.p.toFixed(3)}, α = ${alpha.toFixed(3)})`;

            const methodText = getSelectedMethod() === 'z' ? 'Z-Distribution'
                : getSelectedMethod() === 't' ? 'T-Distribution' : 'Auto-Selected';

            const settingsTable = document.getElementById('printSettingsTable');
            settingsTable.innerHTML = `
                <tr>
                    <td>ระดับความเชื่อมั่น</td>
                    <td>${ciLevel}%</td>
                    <td>ค่า Alpha = ${alpha.toFixed(3)}</td>
                </tr>
                <tr>
                    <td>วิธีการคำนวณ</td>
                    <td>${methodText}</td>
                    <td>${currentMethod === 'auto' ? 'เลือกวิธีโดยอัตโนมัติ' : 'เลือกวิธีด้วยตนเอง'}</td>
                </tr>
                <tr>
                    <td>Critical Value</td>
                    <td>${res.crit.toFixed(3)}</td>
                    <td>ใช้สำหรับคำนวณช่วงความเชื่อมั่น</td>
                </tr>`;
        }

        const conclusionText = generateConclusionText();
        document.getElementById('printConclusionText').textContent = conclusionText;
    }

    function showMethodInfo() {
        const content = `
            <h3>Critical Value Method Selection</h3>
            <p><strong>Auto-Select:</strong> ระบบจะเลือกวิธีที่เหมาะสมให้อัตโนมัติตามขนาดตัวอย่าง</p>
            <ul>
                <li>n ≥ 30: ใช้ Z-Distribution (Normal)</li>
                <li>n &lt; 30: ใช้ T-Distribution</li>
            </ul>
            <p><strong>Z-Distribution:</strong> เหมาะสำหรับกลุ่มตัวอย่างใหญ่ (n ≥ 30) หรือเมื่อทราบความแปรปรวนของประชากร</p>
            <p><strong>T-Distribution:</strong> เหมาะสำหรับกลุ่มตัวอย่างเล็ก (n &lt; 30) หรือเมื่อไม่ทราบความแปรปรวนของประชากร</p>
        `;
        document.getElementById('methodInfoContent').innerHTML = content;
        document.getElementById('methodInfoModal').style.display = 'block';
    }

    function showTooltip(type) {
        let message = '';
        switch(type) {
            case 'auto':
                message = 'ระบบจะเลือกวิธีที่เหมาะสมให้อัตโนมัติ (n ≥ 30: Z, n < 30: T)';
                break;
            case 'z':
                message = 'ใช้ Z-Distribution (Normal) เหมาะสำหรับกลุ่มตัวอย่างใหญ่ (n ≥ 30)';
                break;
            case 't':
                message = 'ใช้ T-Distribution เหมาะสำหรับกลุ่มตัวอย่างเล็ก (n < 30)';
                break;
        }
        alert(message);
    }

    window.onload = function() {
        updateZValueDisplay();
        updateAutoRecommendation();
        updateMethodUI();
        loadHistory();
    };
</script>

</body>
</html>
